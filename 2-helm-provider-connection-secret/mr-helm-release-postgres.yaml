apiVersion: helm.crossplane.io/v1beta1
kind: Release
metadata:
  name: cnr-postgres
spec:
  forProvider:
    chart:
      name: postgresql
      repository: https://charts.bitnami.com/bitnami
      version: 13.0.0
    namespace: cloud-native-rejekts
    values:
      primary:
        persistence:
          size: 1Gi
        pgHbaConfiguration: |-
          local all all trust
          host all all localhost trust
          host inclusion default 0.0.0.0/0 password
      global:
        postgresql:
          auth:
            username: default
            database: inclusion
  connectionDetails:
  - apiVersion: v1
    kind: Service
    name: cnr-postgres-postgresql
    namespace: cloud-native-rejekts
    fieldPath: spec.clusterIP
    toConnectionSecretKey: host
  - apiVersion: v1
    kind: Service
    name: cnr-postgres-postgresql
    namespace: cloud-native-rejekts
    fieldPath: spec.ports[0].port
    toConnectionSecretKey: port
  - apiVersion: v1
    kind: Secret
    name: cnr-postgres-postgresql
    namespace: cloud-native-rejekts
    fieldPath: data.password
    toConnectionSecretKey: password
  - apiVersion: apps/v1
    kind: StatefulSet
    name: cnr-postgres-postgresql
    namespace: cloud-native-rejekts
    fieldPath: spec.template.spec.containers[0].env[4].value
    toConnectionSecretKey: username
  - apiVersion: apps/v1
    kind: StatefulSet
    name: cnr-postgres-postgresql
    namespace: cloud-native-rejekts
    fieldPath: spec.template.spec.containers[0].env[7].value
    toConnectionSecretKey: database
  writeConnectionSecretToRef:
    name: cnr-postgres-connection-secrets
    namespace: cloud-native-rejekts
